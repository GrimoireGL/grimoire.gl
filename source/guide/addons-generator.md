---
type: doc
title: ビルド環境
order: 3
---

## プラグイン開発環境の準備

プラグイン開発環境を簡単に準備できる手法としてプロジェクトのジェネレーターを用いることができる。

### プロジェクトジェネレータのインストール

プロジェクトジェネレータはYoemanというツールを用いて作成されているため、yoemanのインストールが
まず必要である。

```bash
$ npm install yo generator-grimoire-addons -g
```

この後、プロジェクトを生成したいフォルダに移り以下のようなコマンドを実行する。

```bash
$ yo generator-addons
```

これにより、プロジェクトを生成するにあたっていくつかの項目の質問が出るので、これに回答していくと
編集可能なプロジェクトが完成する。

> プラグインプロジェクト作成に際する注意点
>
> * プラグイン名は必ず、`grimoirejs-`がプレフィックスになる。(grimoirejs-webvr、grimoirejs-forward-shadingなど)
> * 生成時にpackage.json生成用の質問が出るが、(mainの項目やtest commandなどはすべてあとでジェネレータにより置換される)

## 開発環境の用い方

### 各種フォルダ

* src ・・・ ソースファイル
* test ・・・ テストファイル

また、この環境下ではsrc以下のフォルダに入っている以下のファイルは特別扱いされる。

* ~Component.tsで終わるソースファイル(コンポーネントの実体をdefault exportする必要がある)
* ~Converter.tsで終わるソースファイル(コンバーターの関数をdefault exportする必要がある)

いずれも、ビルド時に自動的にgrimoire側への登録処理を生成されて登録されるようになっている。

### スキャフォールディング

この環境下では、Grimoire.jsで典型的に作成するファイルは自動生成できる。
以下のようなコマンドで生成が可能である。

```bash
$ npm run scaffold -- -t タイプ -n 名前
```

**タイプ**

生成するファイルのタイプ。`component`もしくは`converter`が入る。

**名前**

生成するファイルの名前。タイプに応じて末尾に`Converter.ts`もしくは`Component.ts`が補完される。

### ビルドコマンド

ビルドするには以下のコマンドを用いると良い。

```bash
$ npm start
```

このコマンドによりsrc内のウォッチ及び、デバッグ用のWebサーバーが`8080`番ポートで走る。

> ES5ビルド
>
> ビルド時間の短縮のためデフォルトではES6のままスクリプトが生成される。
> ただし、`npm start -- --babel`とすると、ES6のスクリプトを変換したES5のスクリプトも生成されるようになる。
> モバイル読み込みなどのためにはこちらのES5のスクリプトが必要だ。

### パブリッシュ

プラグインの公開には、単に`npm publish`を実行すれば良い。
必要なビルド処理やテストの自動実行(テストがある場合)などは自動的に公開準備用のスクリプトが走り、npm上に公開される。

公開された後は、他のプロジェクトにインストールするだけで、そのプロジェクトに存在するコンポーネントやコンバーターなどとともに、index.tsで呼び出された処理が実行されるようになる。


## ビルド用パッケージの詳細

Grimoireのほとんどのパッケージはその複雑なビルド環境を隠蔽して用いることができるように、必要なビルド処理一式や開発環境で用いるパッケージを`grimoirejs-cauldron`というパッケージにまとめている。(なお、cauldronは大釜という意味)

そのため、独自に用意したプロジェクトであってもこれを用いれば多くの場合ビルド環境の恩恵を受けることができる。

プロジェクトジェネレータで生成されたプロジェクトはこのパッケージを同様に使っており、package.jsonないのscriptsの中を参照すれば、cauldronの機能に何があるかわかる。

## yarnの使用

プロジェクトやプラグイン環境でyarnを用いる場合注意が必要である。
npmのように依存先のすべてのパッケージの実行形式のsymlinkをnode_modules直下の.binに生成しないため、yarnでインストールするとうまく動作しない。

そのため、解決手法として以下のパッケージをglobalにインストールすることで解決ができる。
(プロジェクトごとに毎回インストールが必要になるが、グローバルにインストールしなくても問題はない)

```bash
$ yarn global add browserify babel-cli typescript@beta
```
