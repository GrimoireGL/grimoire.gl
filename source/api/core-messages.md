---
type: doc
title: コアメッセージ
order: 1
---

すべてのメッセージは`$`から始まるメソッドによってハンドリングされます。
これは、通常のメソッドとして作成したつもりのコンポーネントないのメソッドが別のコンポーネントが発行するメッセージによって起動してしまうことによるバグなどを抑制するためです。

## GrimoireJS自身が定義するメッセージ群

### treeInitialized

```typescript
  function $treeInitialized(c: ITreeInitializedInfo): void;
```

```typescript
interface ITreeInitializedInfo {
    ownerScriptTag: HTMLScriptElement; // このGOMLを含んでいるスクリプトタグ
    id: string; // 各ツリーに割り振られたユニークなID
}
```

ツリーが初期化された際に呼び出されます。
初期のGOMLの中に記述されているノードが全て初期化されると呼び出されます。

初期化後に追加されたいかなるコンポーネントには呼び出されることはありません。

### mount

```typescript
  function $mount():void;
```

コンポーネントが属するノードがツリーに結びついた際に呼び出されます。

### unmount

```typescript
  function $unmount():void;
```

コンポーネントが属しているノードがツリーからデタッチされた際に呼び出されます。


## ノード初期化時のアルゴリズム

あるノードNが親ノードPに属するように新たにノードNをインスタンス化する際、以下のような順序で初期化されることが想定されている。
```
// コンポーネントの初期化処理
1. Nをインスタンス化
2. FOR c <= すべてのNの必須コンポーネント
2-1. cをインスタンス化してNへセット
2-2. FOR a <= すべてのcの属性
2-2-1. aをインスタンス化してcにセット

3. c <= すべてのNの追加コンポーネント(GOMLないで.COMPONENTSにより指定されたコンポーネント)
3-1. cをインスタンス化してNへセット
3-2. FOR a <= すべてのcの属性
3-2-1 aをインスタンス化してcにセット

4. IF P がnullでない || Pはnullであるが、Nがgomlのルートである(ルートでもなくPがnullなものは含まない(ただのデタッチされたツリー))
4-1. N.parent = P
4-2. Nのすべてのenabledなコンポーネントの属性の初期値を割り当て
(GOMLの値 > Nodeの初期値 > Attributeの初期値　の優先度で割り当て)
4-3. FOR c = Nに属するすべてのenabledなコンポーネント
4-3-1. c.awake(); // <- 初のmountの前に呼び出される。どのコンポーネントに対しても必ず1回しか呼び出されない
4-4. SendMessage('mount') 

```

原則として、**マウントされていないコンポーネントはいかなる処理も呼び出されない**。これには属性の割り当ても含む。(コンストラクタを除く)
(属性の中にはtreeに属さなければ確定しない属性が存在しうるため(セレクタ指定など))

ただし、コンポーネントのコンストラクタに限り、コンポーネントの作者は仮にツリーにマウントされていない状態の処理をすることはできる。
(基本的にコンストラクタの使用は推奨されない)


すべての属性は以下の条件を満たす。
* すべての属性はコンバーターを一度通りコンポーネントに渡される。(defaultValueも含む)
* disabledなコンポーネントには値を渡さない。
* disabledなコンポーネントが属性変更をされた際、そのあとでenabledになったタイミングでコンポーネントに渡される。

## コンポーネントのメソッドのオーバーライドとメッセージ

すべてのメッセージは以下の条件を満たす
* あるメッセージが呼ばれる際、enabledなコンポーネントであればこのメッセージをハンドリングできる
* どのようなメッセージも、disabledなコンポーネントは受信することができない。

このような条件を満たさないコア側からのコンポーネント呼び出しは全てメソッドのオーバーライドによって提供されます。

つまり、あるノードのコンポーネントに等しく起き得ない場合がある場合、それはメッセージではありません。
例えば、初めてコンポーネントがenabledになった際に呼び出されるawakeは、コンポーネントが後から追加された場合、そのコンポーネントだけのawakeを呼ぶことになるので、これはメッセージとして扱われません。
